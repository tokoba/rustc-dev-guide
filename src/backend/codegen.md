# コード生成

コード生成（または「コードジェネレーション」）は、実際に実行可能なバイナリを生成するコンパイラの部分です。通常、rustcはコード生成にLLVMを使用しますが、[Cranelift]と[GCC]のサポートもあります。重要なのは、rustcがコードジェネレーションを自分で実装していないということです。ただし、Rustのソースコードでは、バックエンドの多くの部分に `codegen` という名前が付いていることは注目に値します（明確な境界はありません）。

[Cranelift]: https://github.com/bytecodealliance/wasmtime/tree/main/cranelift
[GCC]: https://github.com/rust-lang/rustc_codegen_gcc

> 注：コード生成のバグをデバッグする方法のヒントをお探しの場合は、[デバッグの章のこのセクション][debugging]を参照してください。

[debugging]: ./debugging.md

## LLVMとは何か？

[LLVM](https://llvm.org)は「モジュール式で再利用可能なコンパイラおよびツールチェーン技術のコレクション」です。特に、LLVMプロジェクトには、多くのコンパイラプロジェクトで使用されているプラグ可能なコンパイラバックエンド（「LLVM」とも呼ばれる）が含まれています。これには、`clang` Cコンパイラと私たちの愛する `rustc` が含まれます。

LLVMは、LLVM IRの形式で入力を受け取ります。これは基本的に、追加の低レベル型と注釈が追加されたアセンブリコードです。これらの注釈は、LLVM IRと出力される機械語の最適化を行うのに役立ちます。このすべての最終結果は、（ついに）実行可能なもの（例：ELFオブジェクト、EXE、またはwasm）です。

LLVMを使用することにはいくつかの利点があります：

- コンパイラバックエンド全体を書く必要がありません。これにより、実装と保守の負担が軽減されます。
- LLVMプロジェクトが収集してきた高度な最適化の大規模なスイートから恩恵を受けることができます。
- LLVMがサポートする任意のプラットフォームにRustを自動的にコンパイルできます。例えば、LLVMがwasmのサポートを追加するとすぐに、いきなり！rustc、clang、その他の多くの言語がwasmにコンパイルできるようになりました！（まあ、他にもやるべきことがありましたが、とにかく90%まで達成していました）。
- 私たちと他のコンパイラプロジェクトがお互いに恩恵を受けます。例えば、[SpectreとMeltdownのセキュリティ脆弱性][spectre]が発見されたとき、パッチが必要だったのはLLVMだけでした。

[spectre]: https://meltdownattack.com/

## LLVMの実行、リンク、メタデータ生成

すべての関数やスタティックなどのLLVM IRが構築されると、LLVMとその最適化パスを実行する時間です。LLVM IRは「モジュール」にグループ化されます。複数の「モジュール」を同時にコード生成して、マルチコアの利用を支援できます。これらの「モジュール」は、私たちが _コードジェネレーション単位_ と呼ぶものです。これらの単位は、モノモーフィゼーションコレクションフェーズの最初の段階で確立されました。

LLVMがこれらのモジュールからオブジェクトを生成すると、これらのオブジェクトは、オプションでメタデータオブジェクトとともにリンカに渡され、アーカイブまたは実行可能ファイルが生成されます。

最適化を実行するのは、必ずしも上記のコードジェネレーションフェーズとは限りません。特定の種類のLTOでは、最適化はリンク時に行われる可能性があります。オブジェクトがリンカに渡される前にいくつかの最適化が行われ、リンク中にいくつか行われることも可能です。

これはすべて、コンパイルの非常に最後に行われます。このコードは [`rustc_codegen_ssa::back`][ssaback] と [`rustc_codegen_llvm::back`][llvmback] にあります。残念ながら、このコード部分はLLVM依存のコードにあまりよく分離されていません。[`rustc_codegen_ssa`][ssa] には、LLVMバックエンドに固有のコードがかなり含まれています。

これらのコンポーネントが作業を完了すると、要求した出力に対応する多数のファイルがファイルシステムに生成されます。

[ssa]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_codegen_ssa/index.html
[ssaback]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_codegen_ssa/back/index.html
[llvmback]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_codegen_llvm/back/index.html
