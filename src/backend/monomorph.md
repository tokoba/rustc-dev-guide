# モノモーフィゼーション

ご存知のように、Rustは非常に表現力豊かな型システムを持ち、ジェネリック型を広範にサポートしています。しかし、もちろん、アセンブリはジェネリックではないため、コードが実行される前に、すべてのジェネリックの具体的な型を把握する必要があります。

異なる言語は、この問題を異なる方法で処理します。例えば、Javaなどの一部の言語では、実行時まで値の最も正確な型がわからない場合があります。Javaの場合、（ほぼ）すべての変数が参照値である（つまり、ヒープに割り当てられたオブジェクトへのポインタ）ため、これは問題ありません。この柔軟性には、パフォーマンスのコストが伴います。オブジェクトへのすべてのアクセスがポインタを逆参照する必要があるためです。

Rustは異なるアプローチを取ります：すべてのジェネリック型を _モノモーフィゼーション_ します。これは、コンパイラが必要な各具体的な型に対してジェネリック関数のコードの異なるコピーをスタンプアウトすることを意味します。例えば、コードで `Vec<u64>` と `Vec<String>` を使用する場合、生成されたバイナリには `Vec` 用に生成されたコードの2つのコピーがあります：`Vec<u64>` 用と `Vec<String>` 用です。結果は高速なプログラムですが、コンパイル時間（すべてのコピーを作成するのに時間がかかる可能性がある）とバイナリサイズ（すべてのコピーが多くのスペースを取る可能性がある）のコストがかかります。

モノモーフィゼーションは、Rustコンパイラのバックエンドの最初のステップです。

## コレクション

まず、プログラム内のすべてのジェネリックなもののために必要な具体的な型を把握する必要があります。これは _コレクション_ と呼ばれ、これを行うコードは _モノモーフィゼーションコレクター_ と呼ばれます。

この例を見てみましょう：

```rust
fn banana() {
   peach::<u64>();
}

fn main() {
    banana();
}
```

モノモーフィゼーションコレクターは、`[main, banana, peach::<u64>]` のリストを提供します。これらは、機械語が生成される関数です。コレクターは、スタティックなどもそのリストに追加します。

詳細については、[コレクターのrustdoc][collect] を参照してください。

[collect]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_monomorphize/collector/index.html

モノモーフィゼーションコレクターは、MIRの低レベル化とコードジェネレーションの直前に実行されます。[`rustc_codegen_ssa::base::codegen_crate`][codegen1] は [`collect_and_partition_mono_items`][mono] クエリを呼び出します。これはモノモーフィゼーションコレクションを行い、それらを[コードジェネレーション単位](../appendix/glossary.md#codegen-unit)に分割します。

## コードジェネレーション単位（CGU）の分割

より良いインクリメンタルビルド時間のために、CGUパーティショナーは各ソースレベルモジュールに対して2つのCGUを作成します。1つは「安定した」つまり非ジェネリックコード用で、もう1つはより揮発性のコード、つまりモノモーフィゼーション/特殊化されたインスタンス用です。

依存関係については、クレートAとクレートBを考え、クレートBがクレートAに依存するとします。次の表は、クレートBの1つ以上のモジュールで使用される可能性のあるクレートA内の関数の異なるシナリオをリストしています。

| クレートAの関数 | 動作 |
| - | - |
| 非ジェネリック関数 | クレートAの関数は、クレートBのどのコードジェネレーション単位にも現れません |
| 非ジェネリック `#[inline]` 関数 |  クレートAの関数は、クレートBの単一のCGU内に現れ、インライン化後の段階でも存在します|
| ジェネリック関数 |  インライン化に関係なく、クレートAからのすべてのモノモーフィゼーション（特殊化）された関数は <br> クレートBの単一のコードジェネレーション単位内に現れます。<br> コードジェネレーション単位は、インライン化後の段階でも存在します。|
| ジェネリック `#[inline]` 関数 |   - 同上 - |

パーティショナーの詳細については、モジュールレベルの[ドキュメント]を読んでください。

[mono]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_monomorphize/partitioning/fn.collect_and_partition_mono_items.html
[codegen1]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_codegen_ssa/base/fn.codegen_crate.html
[documentation]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_monomorphize/partitioning/index.html
