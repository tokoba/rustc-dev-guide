# Windowsでのプロファイリング

## WPRとWPAの紹介

高レベルのパフォーマンス分析(メモリ使用量を含む)は、Windows Performance Recorder(WPR)と
Windows Performance Analyzer(WPA)を使用して実行できます。名前が示すように、WPRは
システム統計の記録用(イベントトレースログ、別名ETLファイルの形式)であり、WPAは
これらのETLファイルの分析用です。

WPRはシステム全体の統計を収集するため、rustcに関連するものだけでなく、
マシン上で実行されている他のすべてのものも記録します。分析中、興味のあるものだけに
フィルタリングできます。

これらのツールは非常に強力ですが、Rustコンパイラを正常にプロファイリングする前に
少し学習が必要です。

ここでは、RustコンパイラのWPRとWPAの使用方法を探求し、
rustcの分析を容易にするために特別に設計されたデフォルトを調整する設定ファイルである
有用な「プロファイル」へのリンクを提供します。

### WPRとWPAのインストール

WPRとWPAは、Windows Performance Toolkitの一部としてインストールでき、
これ自体はWindows Assessment and Deployment Kit(ADK)のダウンロードのオプションです。
ADKインストーラーは[こちら](https://go.microsoft.com/fwlink/?linkid=2086042)からダウンロードできます。
必ずWindows Performance Toolkitを選択してください(他のものを選択する必要はありません)。

## 記録

システム分析を実行するには、まずWPRでシステムを記録する必要があります。WPRを開き、
ウィンドウの下部で、記録したいもののプロファイルを選択します。rustcブートストラッププロセスの
メモリ使用量を調べるには、以下の項目を選択する必要があります:

* CPU usage
* VirtualAlloc usage

「Heap usage」も記録したくなるかもしれませんが、これはすべてのヒープ割り当てを記録し、
非常に高コストになる可能性があります。高レベルの分析では、これをオフのままにしておくのが
最善かもしれません。

次に、記録の準備をする必要があります。メモリ使用量分析の場合、デバッグシンボルを持つ
stage 1コンパイラビルドでstage 2コンパイラビルドを記録するのが最適です。
rustcのビルドに使用するコンパイラにシンボルがあると、WPAがRustシンボルを正しく解決できるため、
分析が大幅に向上します。残念ながら、stage 0コンパイラにはシンボルがオンになっていないため、
stage 1コンパイラとstage 2コンパイラを自分でビルドする必要があります。

これを行うには、`bootstrap.toml`ファイルで`debuginfo-level = 1`を設定したことを確認してください。
これにより、rustcにブートストラップ時にスタックフレームを含むデバッグ情報を生成するように指示します。

これで、stage 1コンパイラをビルドできます: `x build --stage 1 -i library`または
stage 1コンパイラをビルドしたい他の方法で。

stage 1コンパイラがビルドされたので、stage 2ビルドを記録できます。WPRに戻り、
「start」ボタンをクリックして、stage 2コンパイラをビルドします(例: `x build --stage=2 -i library`)。
このプロセスが終了したら、記録を停止します。

Saveボタンをクリックし、そのプロセスが完了したら、表示される「Open in WPA」ボタンをクリックします。

> 注意: トレースファイルはかなり大きいため、WPAがファイルを開き終えるまでに時間がかかることがあります。

## 分析

ETLファイルがWPAで開かれたので、結果を分析できます。まず、事前に作成された「プロファイル」を
適用します。これにより、WPAがrustcブートストラップの分析に適した状態になります。
プロファイルを[こちら](https://github.com/wesleywiser/rustc-bootstrap-wpa-analysis/releases/download/1/rustc.generic.wpaProfile)からダウンロードします。
上部の「Profiles」メニューを選択し、「apply」を選択してから、ダウンロードしたプロファイルを選択します。

次のようなものが表示されるはずです:

![WPA with profile applied](../img/wpa-initial-memory.png)

次に、WPAにデバッグシンボルをロードして処理するように指示する必要があります。これにより、
Rustスタックトレースを適切にデマングルできます。これを行うには、「Trace」をクリックして
「Load Symbols」を選択します。このステップには時間がかかることがあります。

WPAがrustcのシンボルをロードしたら、rustc.exeノードを展開して、最大の割り当てを持つスタックに
掘り下げ始めることができます。

これを行うには、「Commit Stack」列の`[Root]`ノードを展開し、興味深いスタックフレームが
見つかるまで展開を続けます。

> ヒント: 展開したいノードを選択した後、右矢印キーを押します。これによりノードが展開され、
> 展開されたセット内の次に大きいノードに選択が移動します。興味深いフレームに到達するまで
> 右矢印キーを押し続けることができます。

![WPA with expanded stack](../img/wpa-stack.png)

このサンプルでは、codegenを通じた呼び出しがこのプロファイル全体で合計約30gbのメモリを
割り当てていることがわかります。

## その他の分析タブ

プロファイルには、役立つ可能性のあるいくつかの他のタブも含まれています:

- System Configuration
    - キャプチャが記録されたシステムに関する一般情報。
- rustc Build Processes
    - rustc.exe、cargo.exe、link.exeなどの関連プロセスのフラットリスト。
    - 各プロセスはコマンドライン引数をリストします。
    - 特定のrustcプロセスが何に取り組んでいたかを把握するのに役立ちます。
- rustc Build Process Tree
    - プロセスがいつ開始および終了したかを示すタイムライン。
- rustc CPU Analysis
    - rustcのホットスポットを表示するように事前設定されたグラフが含まれています。
    - これらのグラフは、rustcが時間を費やしている場所の分析をサポートするように設計されています。
- rustc Memory Analysis
    - rustcがメモリを割り当てている場所を表示するように事前設定されたグラフが含まれています。
