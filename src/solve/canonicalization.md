# 正規化

正規化（Canonicalization）は、値をそのコンテキストから*分離する*プロセスであり、推論変数を含むゴールのグローバルキャッシングに必要です。

考え方は、`u32: Trait<?x>`と`u32: Trait<?y>`というゴールが与えられた場合、ここで`?x`と`?y`は
2つの異なる現在制約されていない推論変数であり、両方のゴールで同じ結果を得るべきです。したがって、*正規ゴール*`exists<T> u32: Trait<T>`を一度証明し、
結果を再利用できます。

まず、正規クエリの動作方法を説明してから、正規化の仕組みの詳細に入ります。

## 正規クエリのウォークスルー

これを少し簡単にするために、トレイトゴール`u32: Trait<?x>`を例として使用し、関連するimplが`impl<T> Trait<Vec<T>> for u32`のみであるという仮定を置きます。

### 入力の正規化

推論変数を存在境界変数で、プレースホルダを普遍境界変数で置き換えることによって、ゴールを*正規化*することから始めます。これにより、*正規ゴール*
`exists<T> u32: Trait<T>`が得られます。

すべての境界変数の元の値を元のコンテキストで記憶します。ここでは、
`T`を`?x`にマップします。これらの元の値は、後でクエリレスポンスを処理する際に使用されます。

次に、正規ゴールで正規クエリを呼び出します。

### クエリ内での正規ゴールのインスタンス化

正規ゴールを実際に証明しようとするために、境界変数を
推論変数とプレースホルダで再びインスタンス化することから始めます。

これは、完全に別の`InferCtxt`でクエリ内で行われます。クエリ内では、
ゴール`u32: Trait<?0>`があります。また、正規ゴールの境界変数をインスタンス化するために使用した値も記憶します。これは`T`を`?0`にマップします。

次にゴール`u32: Trait<?0>`を計算し、これが成り立つことがわかりますが、
`?0`を`Vec<?1>`に制約しました。最後に、この結果を呼び出し側にとって有用なものに変換します。

### クエリレスポンスの正規化

ゴールが成り立つかどうかと、クエリ内からの推論制約の両方を
呼び出し側に返す必要があります。

推論結果を呼び出し側に返すために、境界変数から
クエリ内でインスタンス化された値へのマッピングを正規化します。これは、クエリレスポンスが`Certainty::Yes`と
`T`から`exists<U> Vec<U>`へのマッピングであることを意味します。

### クエリレスポンスのインスタンス化

呼び出し側は、クエリによって返された制約を適用する必要があります。このために、まず
正規レスポンスの境界変数を推論変数と
プレースホルダで再びインスタンス化するため、レスポンス内のマッピングは`T`から`Vec<?z>`になります。

次に、`T`の元の値（`?x`）とレスポンス内の`T`の値（`Vec<?z>`）を等しくし、
これにより`?x`を`Vec<?z>`に正しく制約します。

## `ExternalConstraints`

トレイトゴールを計算すると、推論変数を制約するだけでなく、領域
義務も追加される可能性があります。たとえば、ゴール`(): AOutlivesB<'a, 'b>`が与えられた場合、
`'a: 'b`が成り立つ必要があるという事実を返したいと思います。

これは、クエリから境界変数からインスタンス化された値へのマッピングを返すだけでなく、
レスポンスを構築する際に`InferCtxt`コンテキストから追加の`ExternalConstraints`を抽出することによって行われます。

## 正規化は正確にどのように機能するか

TODO: PRがランディングしたらコードにリンクし、詳しく説明する

- 型と定数：推論を存在境界変数に、プレースホルダを普遍境界変数に、
    ユニバースを考慮して
- 入力のジェネリックパラメータはルートユニバースのプレースホルダとして扱われます
- 入力のすべての領域はすべて存在境界変数にマッピングされ、「一意化」します。
    `&'a (): Trait<'a>`は`exists<'0, '1> &'0 (): Trait<'1>`に正規化されます。
    それらのユニバースは気にせず、すべての領域を入力の最高のユニバースに入れます。
- 出力では、呼び出し側のユニバースにあるものはすべてルートユニバースに入れられ、
    呼び出し側の元の値と変数値を統一するときにのみ正しいユニバースを取得します
- レスポンスでは領域を一意化せず、`'static`を正規化しません
