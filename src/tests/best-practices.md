# テストを書くためのベストプラクティス

この章では、テストの作成と変更に関連するベストプラクティスについて説明します。元の作成者に相談したり、大量のgitの考古学を行うことなく、数年後でも理解しやすく変更しやすいテストを作成したいと考えています。

作成したテストを、数年後に失敗したテストを見ている別のコントリビューターであるふりをしてレビューするのは良い習慣です（これは数日または数ヶ月後の自分自身にも役立ちます！）。そして、自分自身に問いかけてください：どうすれば自分と彼らの生活を楽にできるでしょうか？

これを見通しに入れるために、別のコントリビューターの生活をできるだけ困難にするテストを書く方法についての余談から始めましょう。

> **余談：シンプルなテストサボタージュ・フィールドマニュアル**
>
> 別のコントリビューターの生活をできるだけ困難にするには、次のようにします：
>
> - テストを問題番号だけで命名し、他のコンテキストを含めない。例：`issue-123456.rs`。
> - テストが何を実行しようとしているのか、関連するコンテキストへのリンクについてのコメントを一切持たない。
> - 大規模な（他の方法で最小化できる）テストを含め、テストが実際にテストしようとしているコアなものから気を散らす非本質的な部分を含める。
> - テストがチェックしようとしているものにとって重要でない、無関係な構文エラーやその他のエラーの束を含める。
> - スニペットを奇妙にフォーマットする。
> - 使用されていない無関係な機能の束を含める。
> - 例えば`ignore-windows`のような[compiletestディレクティブ]を持っているが、*なぜ*それらが必要なのかについての説明を提供しない。

## テストの命名

テストが何を実行しようとしているかを読者がすぐに理解できるようにし、問題番号を入力してgithub検索を掘り下げてテストが何を実行しようとしているかを調べる必要がないようにします。これには、`--test-args`を介して関連するテストのコレクションとしてフィルタリングできるようにするという追加の利点があります。

- テストを、それが実行しようとしていること、または回帰を防止しようとしていることにちなんで命名してください。
- 簡潔にしてください。
- テスト名として問題番号だけを使用しないでください。
- テスト名を`issue-xxxxx`プレフィックスで始めないでください。オートコンプリートが劣化します。

> **テスト名として問題番号だけを使用しないでください**
>
> 代わりに、テストコメントにリンクまたは`#123456`として含めることを好みます。または、問題番号を含めることが理にかなっている場合は、`macro-external-span-ice-123956.rs`のような簡単なキーワードも含めてください。
>
> ```text
> tests/ui/typeck/issue-123456.rs                              // 悪い
> tests/ui/typeck/issue-123456-asm-macro-external-span-ice.rs  // 悪い（タブ補完のため）
> tests/ui/typeck/asm-macro-external-span-ice-123456.rs        // 良い
> tests/ui/typeck/asm-macro-external-span-ice.rs               // 良い
> ```
>
> `issue-123456.rs`は、テストが実際に何を実行しているかについて即座に何も教えてくれないため、追加の検索を行う必要があります。テスト名にプレフィックスとして問題番号を含めると、タブ補完の有用性が低下します（テストディレクトリを`ls`して、たくさんの`issue-xxxxx`プレフィックスを取得する場合）。テストコメントで問題にリンクできます。
>
> ```rs
> //! `asm!`マクロが外部クレートから来るネストされたマクロを含む場合、
> //! コードポイント境界アサーションICEにつながらないことを確認してください。
> //!
> //! <https://github.com/rust-lang/rust/issues/123456>の回帰テスト。
> ```
>
> このルールの1つの例外は、[クラッシュテスト]です：その目的は、もはやICE/クラッシュしない問題からのスニペットを追跡することであり、修正PRで適切なui/他のテストに削除または変換されるため、問題番号のみにちなんでテストに名前を付けることが標準です。

## テストの整理

- ほとんどのテストスイートについて、テストをホームする意味的に意味のあるサブディレクトリを見つけるようにしてください。
    - 例えば、RFC 2093の実装特有のものについては、`tests/ui/rfc-2093-infer-outlives/`の下にテストのコレクションをグループ化できます。ディレクトリ名には、RFCが何についてのものかを含めてください。
- [`run-make`]/`run-make-support`テストスイートの場合、各`rmake.rs`は`tests/run-make/`または`tests/run-make-cargo/`の直下のサブディレクトリ内に含まれている必要があります。さらなるネストは現在サポートされていません。テスト名として問題番号_のみ_を使用することも避けてください。

## テストの説明

変更がテストの失敗につながった場合に他のコントリビューターがテストが何についてのものかを理解できるようにするために、テストがその意図/目的、関連するコンテキストへのリンク（問題番号やその他のディスカッションを含む）、および可能性のある関連リソース（例えば、特定の動作のWin32 APIにリンクすることが役立つ場合があります）について十分なドキュメントを持っていることを確認する必要があります。

**良いコメントを持つテストの概要**

```rust,ignore
//! テストが実行しているものの簡単な要約。
//! 例：#123456の回帰テスト：カバレッジ属性が非アイテムに適用されたときに
//!     ICEしないことを確認してください。
//!
//! オプション：関連するテスト/問題、外部API/ツール、クラッシュ
//!     メカニズム、修正方法、FIXME、制限などに関する備考。
//! 例：このテストは`tests/attrs/linkage.rs`のようなものですが、このテストは
//!     特に`#[coverage]`をチェックしており、異なるコード
//!     パスを実行します。ICEは、属性検証中に
//!     `def_path_str`を構築しようとしたときにトリガーされましたが、プラット
//!     フォームがwindowsの場合にのみ診断を発行し、unixでICEを引き起こしました。
//!
//! 関連する問題とディスカッションへのリンク。以下は例です：
//! <https://github.com/rust-lang/rust/issues/123456>の回帰テスト。
//! <https://github.com/rust-lang/rust/issues/101345>も参照してください。
//! <https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/123456-example-topic>でのディスカッションを参照してください。
//! [`clone(2)`]を参照してください。
//!
//! [`clone(2)`]: https://man7.org/linux/man-pages/man2/clone.2.html

//@ ignore-windows
// 理由：（このテストがwindowsで無視される理由は？具体的に
// windows-gnuまたはwindows-msvcではないのはなぜですか？）

// オプション：テストケースの要約：どのようなポジティブケースがチェックされていますか？
// どのようなネガティブケースがチェックされていますか？特定の癖はありますか？

fn main() {
    #[coverage]
    //~^ ERROR coverage attribute can only be applied to function items.
    let _ = {
        // 読者の注意に値するものを強調するコメント。
        fn foo() {}
    };
}
```

どの程度のコンテキスト/説明が必要かは、作成者とレビュアーの裁量次第です。良い経験則は、テストで実行される自明でないものは、他のコントリビューターが理解するのに役立つ何らかの説明に値するということです。これには次のような備考が含まれる場合があります：

- ICEがかなり複雑な場合、どのようにトリガーされるか。
- 関連する問題とテスト（例：このテストは別のテストのようなものですが、...という理由で別々に保たれています）。
- プラットフォーム固有の動作。
- 外部依存関係とAPIの動作：syscall、リンカー、ツール、環境など。

## テストの内容

- テストをできるだけ最小限にするようにしてください。
- 重要でないコードを最小限にし、特にstderrスナップショットを雑然とさせる可能性のある不要な構文エラーや型エラーを最小限にしてください。
- 可能な限り、意味的に意味のある名前を使用してください（例：`fn bare_coverage_attributes() {}`）。

## 不安定なテスト

すべてのテストは、再現可能で信頼性があるように努める必要があります。不安定なテストは最悪の種類のテストであり、最初からテストを持たないよりも間違いなく悪いです。

- 不安定なテストは、完全に無関係なPRで失敗する可能性があり、他のコントリビューターを混乱させ、テストの失敗が関連しているかどうかを把握しようとして時間を無駄にする可能性があります。
- 不安定なテストは、不安定で信頼できないこと以外に、テスト結果から有用な情報を提供しません：テストが合格したが不安定な場合、運が良かっただけですか？テストが不安定だが失敗した場合、単に偽陽性でしたか？
- 不安定なテストは、テストスイート全体への信頼を低下させます。テストスイートが不安定なテストのためにランダムに偽陽性で失敗する可能性がある場合、テストスイート全体が合格したのか、それとも運が良かった/悪かっただけですか？
- 不安定なテストは、完全なCIでランダムに失敗し、貴重な完全なCIリソースを無駄にする可能性があります。

## Compiletestディレクティブ

ディレクティブのリストについては、[compiletestディレクティブ]を参照してください。

- `ignore-*`/`needs-*`/`only-*`ディレクティブの場合、非常に明白でない限り、ディレクティブが必要な理由について簡単な備考を提供してください。例：`"//@ ignore-wasi (wasi codegens the main symbol differently)"`。
- `//@ ignore-auxiliary`を使用する場合は、対応するメインテストファイルを指定してください。例：``//@ ignore-auxiliary (used by `./foo.rs`)``。

## FileCheckのベストプラクティス

詳細については、[LLVM FileCheckガイド][FileCheck]を参照してください。

- 特別または重要でない限り、特定のレジスタ番号または基本ブロック番号に一致しないでください。適切な場合はパターンを使用してそれらに一致することを検討してください。

> **TODO**
>
> 具体的なアドバイスを待っています。

[compiletest]: ./compiletest.md
[compiletestディレクティブ]: ./directives.md
[`run-make`]: ./compiletest.md#run-make-tests
[FileCheck]: https://llvm.org/docs/CommandGuide/FileCheck.html
[クラッシュテスト]: ./compiletest.md#crash-tests
