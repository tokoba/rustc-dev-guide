# [`CoerceUnsized`](https://doc.rust-lang.org/std/ops/trait.CoerceUnsized.html)

`CoerceUnsized` は主にデータコンテナに関係しています。構造体
（通常はスマートポインタ）が `CoerceUnsized` を実装する場合、それは
それが指すデータがアンサイズされていることを意味します。

`CoerceUnsized` の実装者には次のものがあります：

* `&T`
* `Arc<T>`
* `Box<T>`

このトレイトは（最終的に）ユーザーが書いたスマートポインタによって
実装されることを意図しており、型が `CoerceUnsized` を実装することが
許可される場合についての規則があります。これらはトレイトのドキュメントで
説明されています。

# [`Unsize`](https://doc.rust-lang.org/std/marker/trait.Unsize.html)

対照的に、`Unsize` トレイトは、アンサイズされることが許可される実際の型に
関係しています。

これはユーザーによって実装されることを意図していません。なぜなら、
`Unsize` は型をアンサイズする*方法*をコンパイラ（つまりコード生成）に
指示するのではなく、アンサイズされることが許可されているかどうかのみを
指示するからです。これはコード生成と多少密接にペアになっており、
型がどのように表現され、アンサイズされるかを理解する必要があります。

## プリミティブなアンサイズ実装

組み込みの実装は次のために提供されています：

* `T` -> `dyn Trait + 'a`（`T: Trait` かつ `T: Sized + 'a`、および `Trait` が
  dyn 互換[^2]の場合）
* `[T; N]` -> `[T]`

## 構造的実装

`Unsize` の実装の1つは構造的と考えることができます：

* `Struct<.., Pi, .., Pj, ..>: Unsize<Struct<.., Ui, .., Uj, ..>>` は
  `TailField<Pi, .., Pj>: Unsize<Ui, .. Uj>` が与えられた場合に成り立ちます。
  これにより、構造体の末尾フィールドは、ジェネリックパラメータ `Pi`、..、`Pj`
  （連続している必要はありません）に言及する唯一のフィールドである場合に
  アンサイズできます。

構造体のアンサイズの規則は少し複雑です。なぜなら、複数のパラメータが
変更される（必ずしもアンサイズされるわけではない）ことを許可する可能性があり、
構造体の末尾フィールドの観点から最もよく述べられるからです。

（タプルのアンサイズは以前、機能ゲート `unsized_tuple_coercion` の背後で
実装されていましたが、実装は [#137728] によって削除されました。）

[#137728]: https://github.com/rust-lang/rust/pull/137728

## アップキャスト実装

内部で「アップキャスト」と呼ばれるものは2つあります：

1. 真のアップキャスト `dyn SubTrait` -> `dyn SuperTrait`（これは以下のように
   自動トレイトを削除し、ライフタイムを調整することも許可します）。
2. *プリンシパルを変更せずに*dyn トレイトの自動トレイトを削除し、
   ライフタイムを調整する：`dyn Trait + AutoTraits... + 'a` ->
   `dyn Trait + NewAutoTraits... + 'b`（`AutoTraits` ⊇ `NewAutoTraits` かつ
   `'a: 'b` の場合）。

これらは異なる操作のように見えるかもしれません。なぜなら、(1.) は dyn トレイトの
vtable の調整を含みますが、(2.) は no-op だからです。しかし、型システムにとっては、
これらはほぼ同じコードで処理されます。

この `Unsize` の組み込み実装は最も複雑であり、特に関連型の複雑さを
サポートするために[再構築された](https://github.com/rust-lang/rust/pull/114036)後です。

具体的には、アップキャストアルゴリズムには次が含まれます：ソース dyn トレイトの
プリンシパルの各スーパートレイト（それ自体を含む）に対して...

1. スーパートレイト参照をターゲットのプリンシパルと単一化します（真のスーパートレイト
   にのみアップキャストし、決して [impl 経由]でアップキャストしないことを確認します）。
2. ターゲットのすべての自動トレイトに対して、それがソースに存在することを
   チェックします（自動トレイトを削除できますが、新しいものを取得することは
   決してありません）。
3. ターゲットのすべてのプロジェクションに対して、ソースの単一のプロジェクションと
   単一化することをチェックします（`trait Sub: Sup<.., A = i32> + Sup<.., A = u32>`
   が与えられた場合、複数ある可能性があるため）。

具体的には、(3.) はプロジェクション境界の選択が不必要に推論を導くことを
防ぎますが、明確な場合は推論を導く可能性があります。

[^2]: 以前は「オブジェクト安全」として知られていました。
